sequenceDiagram
    %% ============================================================
    %% FLUJO: Cambiar la ruta de oportunidades en configuracion
    %% Actor: Usuario abre el configurador y selecciona nueva ruta
    %% ============================================================
    title Cambiar Configuracion (RutaOportunidades)

    actor Usuario

    box "4-UI"
        participant Ribbon as clsRibbon
        participant FrmCfg as frmConfiguracion
    end

    box "1-Aplicacion"
        participant Dispatcher as clsEventDispatcher
        participant App as clsApplication
    end

    box "2-Infraestructura"
        participant Cfg as clsConfiguration
        participant OppProv as FileSystemOpportunityProvider
    end

    box "3-Dominio"
        participant OppMgr as clsOpportunitiesMgr
    end

    %% ----------------------------------------------------------
    %% PARTE 1: ABRIR EL FORMULARIO
    %% ----------------------------------------------------------

    Note over Usuario,OppMgr: === PARTE 1: USUARIO ABRE LA CONFIGURACION ===

    Usuario->>Ribbon: Clic en boton "Configurador"
    Ribbon->>Dispatcher: Dispatch("btnConfig")
    Note right of Dispatcher: [Dispatch] case "btnConfig":<br/>App.Configuration.ShowUI<br/>(llamada modal - bloquea hasta que el usuario cierra)

    Dispatcher->>Cfg: App.Configuration.ShowUI()
    Note right of Cfg: [ShowUI] Crea frmConfiguracion,<br/>llama frm.Cargar(Me), frm.Show vbModal

    Cfg->>FrmCfg: New frmConfiguracion
    Cfg->>FrmCfg: Cargar(oConf)
    Note right of FrmCfg: [Cargar] Carga valores actuales<br/>en los TextBox del formulario

    FrmCfg-->>Usuario: Formulario visible con rutas actuales

    %% ----------------------------------------------------------
    %% PARTE 2: USUARIO SELECCIONA NUEVA CARPETA
    %% ----------------------------------------------------------

    Note over Usuario,OppMgr: === PARTE 2: USUARIO CAMBIA LA RUTA ===

    Usuario->>FrmCfg: Clic en boton "Seleccionar" junto a Oportunidades
    FrmCfg-->>Usuario: Dialogo de seleccion de carpeta
    Usuario->>FrmCfg: Selecciona nueva carpeta
    Note right of FrmCfg: [CommandButtonSelFldOportunidades_Click]<br/>mConf.RutaOportunidades = nuevaRuta<br/>(Property Let: guarda en registro Windows)

    FrmCfg->>Cfg: RutaOportunidades = nuevaRuta (Property Let)
    Note right of Cfg: Guarda en registro. Solo eso.<br/>NO dispara eventos: la UI sabe lo que cambio.

    Usuario->>FrmCfg: Cierra el formulario
    FrmCfg-->>Cfg: ShowUI() retorna (modal desbloqueado)

    %% ----------------------------------------------------------
    %% PARTE 3: LA UI CONTROLA EL FLUJO -> REFRESH
    %% ----------------------------------------------------------

    Note over Usuario,OppMgr: === PARTE 3: DISPATCHER CONTROLA EL FLUJO ===

    Note right of Dispatcher: ShowUI() retorno -> la UI sabe que el usuario<br/>pudo cambiar la config -> llama RefreshAfterConfigChange

    Dispatcher->>App: App.RefreshAfterConfigChange()
    Note right of App: [RefreshAfterConfigChange] Facade: coordina<br/>la actualizacion sin ser un gestor de eventos

    App->>OppProv: mOpportunityProvider.RefreshStorageAvailability()
    Note right of OppProv: [RefreshStorageAvailability]<br/>ExisteCarpeta(nuevaRuta)<br/>Actualiza mIsReady True/False

    App->>OppMgr: mOpportunities.RefreshOpportunities()
    Note right of OppMgr: [RefreshOpportunities]<br/>GetOpportunities() -> BuildOpportunityObjects()<br/>con la nueva ruta de configuracion

    OppMgr-->>Ribbon: RaiseEvent OpportunityCollectionUpdated("refresh")
    Note right of Ribbon: [mOpportunities_OpportunityCollectionUpdated]<br/>clsRibbon escucha via WithEvents mOpportunities<br/>Invalida ddlOportunidades

    %% ----------------------------------------------------------
    %% PARTE 4: FLUJO DE ERROR (red caida - FSWatcher detecta error)
    %% ----------------------------------------------------------

    Note over Usuario,OppMgr: === PARTE 4: RED SE CAE (gestionado por mediador de dominio) ===

    Note over OppMgr: El mediador de dominio (clsEventsMediatorDomain)<br/>ya esta suscrito a MonitoringError/Failed/Reconnected.<br/>clsApplication NO necesita suscribirse: no es un gestor de eventos.

    Note over OppProv: CreateOpportunityFolder() llama RefreshStorageAvailability()<br/>antes de escribir en el FS (re-consulta fresca en el momento critico).

    Note over OppMgr: Si la red falla, el siguiente intento de CreateOpportunity<br/>o RefreshOpportunities fallara con el error natural del FS.
